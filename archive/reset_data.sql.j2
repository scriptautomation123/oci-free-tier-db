-- Reset Data SQL Template
-- This script truncates all tables and resets sequences in the schema

SET ECHO OFF
SET FEEDBACK ON
SET HEADING OFF
SET PAGESIZE 0

-- Display current operation
SELECT 'Resetting data for schema: {{ schema_user }}' FROM DUAL;

-- Truncate all tables in the schema
BEGIN
  FOR tab IN (SELECT table_name FROM user_tables WHERE table_name NOT LIKE 'BIN$%') LOOP
    BEGIN
      EXECUTE IMMEDIATE 'TRUNCATE TABLE ' || tab.table_name;
      DBMS_OUTPUT.PUT_LINE('Truncated table: ' || tab.table_name);
    EXCEPTION
      WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('Warning: Could not truncate ' || tab.table_name || ': ' || SQLERRM);
    END;
  END LOOP;
END;
/

-- Reset all sequences to start value
BEGIN
  FOR seq IN (SELECT sequence_name FROM user_sequences) LOOP
    BEGIN
      EXECUTE IMMEDIATE 'DROP SEQUENCE ' || seq.sequence_name;
      EXECUTE IMMEDIATE 'CREATE SEQUENCE ' || seq.sequence_name || ' START WITH 1';
      DBMS_OUTPUT.PUT_LINE('Reset sequence: ' || seq.sequence_name);
    EXCEPTION
      WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('Warning: Could not reset sequence ' || seq.sequence_name || ': ' || SQLERRM);
    END;
  END LOOP;
END;
/

-- Clear any temporary objects or log tables
BEGIN
  FOR temp_obj IN (SELECT object_name, object_type FROM user_objects 
                   WHERE object_name LIKE '%TEMP%' OR object_name LIKE '%LOG%'
                   AND object_type IN ('TABLE', 'VIEW')) LOOP
    BEGIN
      IF temp_obj.object_type = 'TABLE' THEN
        EXECUTE IMMEDIATE 'TRUNCATE TABLE ' || temp_obj.object_name;
        DBMS_OUTPUT.PUT_LINE('Cleared temporary table: ' || temp_obj.object_name);
      END IF;
    EXCEPTION
      WHEN OTHERS THEN
        DBMS_OUTPUT.PUT_LINE('Warning: Could not clear ' || temp_obj.object_name || ': ' || SQLERRM);
    END;
  END LOOP;
END;
/

-- Display summary
SELECT 'Data reset complete for schema: {{ schema_user }}' FROM DUAL;
SELECT 'Tables truncated: ' || COUNT(*) FROM user_tables WHERE table_name NOT LIKE 'BIN$%';
SELECT 'Sequences reset: ' || COUNT(*) FROM user_sequences;

EXIT;