---
# ============================================================================
# Oracle Cloud Infrastructure Provisioning - GitHub Actions Workflow
# ============================================================================
# Description: Automated infrastructure provisioning using Terraform
# Best Practice: Direct Terraform execution (no Ansible wrapper in CI/CD)
# Cost Protection: Always Free tier validation built-in
# ============================================================================

name: Provision OCI Infrastructure

on:
  # Manual trigger for infrastructure provisioning (no user inputs)
  workflow_dispatch:

  # Trigger on Terraform changes (plan only)
  pull_request:
    branches: [main]
    paths:
      - "terraform/**"
      - ".github/workflows/provision-infrastructure.yml"

  # Trigger on push to main (plan only - requires manual approval for apply)
  push:
    branches: [main]
    paths:
      - "terraform/**"

# Prevent concurrent executions
concurrency:
  group: terraform-${{ github.ref }}
  cancel-in-progress: false

env:
  # Terraform version - pinned for consistency
  TERRAFORM_VERSION: "1.5.0"
  # Working directory
  TERRAFORM_DIR: "./terraform"
  # OCI Provider configuration via environment variables
  TF_VAR_region: "us-ashburn-1"

jobs:
  # ============================================================================
  # Job 1: Validate Always Free Tier Configuration
  # ============================================================================
  validate-free-tier:
    name: Validate Always Free Tier Configuration
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check terraform.tfvars for Always Free tier settings
        run: |
          echo "Validating Always Free tier configuration..."

          # Check if example file exists (for new deployments)
          if [ -f "terraform/terraform.tfvars.example" ]; then
            TFVARS_FILE="terraform/terraform.tfvars.example"
          elif [ -f "terraform/terraform.tfvars" ]; then
            TFVARS_FILE="terraform/terraform.tfvars"
          else
            echo "ERROR: No terraform.tfvars file found!"
            exit 1
          fi

          echo "Checking file: $TFVARS_FILE"

          # Validate critical Always Free tier settings
          VALIDATION_FAILED=0

          if ! grep -q "is_free_tier = true" "$TFVARS_FILE"; then
            echo "ERROR: is_free_tier must be set to true"
            VALIDATION_FAILED=1
          fi

          if ! grep -q "cpu_core_count = 1" "$TFVARS_FILE"; then
            echo "ERROR: cpu_core_count must be set to 1 for Always Free tier"
            VALIDATION_FAILED=1
          fi

          if ! grep -q "storage_size_tbs = 0.02" "$TFVARS_FILE"; then
            echo "ERROR: storage_size_tbs must be set to 0.02 (20GB) for Always Free tier"
            VALIDATION_FAILED=1
          fi

          if ! grep -q "auto_scaling_enabled = false" "$TFVARS_FILE"; then
            echo "ERROR: auto_scaling_enabled must be set to false for Always Free tier"
            VALIDATION_FAILED=1
          fi

          if ! grep -q "acknowledge_free_tier_limits = true" "$TFVARS_FILE"; then
            echo "ERROR: acknowledge_free_tier_limits must be set to true"
            VALIDATION_FAILED=1
          fi          if [ $VALIDATION_FAILED -eq 1 ]; then
            echo ""
            echo "COST PROTECTION: Configuration does not meet Always Free tier requirements!"
            exit 1
          fi

          echo "Always Free tier configuration validated successfully"
          echo "Cost: \$0.00 (Always Free tier protected)"

  # ============================================================================
  # Job 2: Terraform Plan
  # ============================================================================
  terraform-plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    needs: validate-free-tier

    # Set permissions for GitHub token
    permissions:
      contents: read
      pull-requests: write

    outputs:
      plan-exitcode: ${{ steps.plan.outputs.exitcode }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          # Enable Terraform output for use in subsequent steps
          terraform_wrapper: true

      - name: Configure OCI credentials
        run: |
          echo "Configuring OCI credentials..."
          mkdir -p ~/.oci

          # Note: In production, you would configure OCI credentials here
          # For now, we'll rely on Terraform variables passed via secrets
          echo "OCI credential configuration prepared"

      - name: Terraform Format Check
        id: fmt
        run: terraform fmt -check -recursive
        working-directory: ${{ env.TERRAFORM_DIR }}
        continue-on-error: true

      - name: Terraform Init
        id: init
        run: terraform init
        working-directory: ${{ env.TERRAFORM_DIR }}

      - name: Terraform Validate
        id: validate
        run: terraform validate -no-color
        working-directory: ${{ env.TERRAFORM_DIR }}

      - name: Terraform Plan
        id: plan
        run: |
          terraform plan \
            -var-file=terraform.tfvars.example \
            -out=tfplan \
            -no-color \
            -detailed-exitcode || export PLAN_EXIT=$?

          # Exit codes: 0 = no changes, 1 = error, 2 = changes present
          if [ "${PLAN_EXIT:-0}" -eq 1 ]; then
            echo "Terraform plan failed"
            exit 1
          fi

          echo "exitcode=${PLAN_EXIT:-0}" >> $GITHUB_OUTPUT

          if [ "${PLAN_EXIT:-0}" -eq 2 ]; then
            echo "Changes detected in Terraform plan"
          else
            echo "No infrastructure changes required"
          fi
        working-directory: ${{ env.TERRAFORM_DIR }}
        env:
          # Pass secrets as Terraform variables
          TF_VAR_compartment_ocid: ${{ secrets.OCI_COMPARTMENT_OCID }}
          TF_VAR_admin_password: ${{ secrets.DB_ADMIN_PASSWORD }}
        continue-on-error: true

      - name: Upload Terraform Plan
        if: steps.plan.outputs.exitcode == '2'
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan
          path: ${{ env.TERRAFORM_DIR }}/tfplan
          retention-days: 5

      - name: Comment PR with Plan
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const output = `#### Terraform Format and Style ðŸ–Œ\`${{ steps.fmt.outcome }}\`
            #### Terraform Initialization \`${{ steps.init.outcome }}\`
            #### Terraform Validation \`${{ steps.validate.outcome }}\`
            #### Terraform Plan \`${{ steps.plan.outcome }}\`

            <details><summary>Show Plan</summary>

            \`\`\`terraform
            Terraform plan output is available in the workflow logs.
            Review the 'Terraform Plan' step for detailed changes.
            \`\`\`

            </details>

            **Always Free Tier Protection:** Validated
            **Estimated Cost:** $0.00 (Always Free tier)

            *Pushed by: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })

      - name: Plan Status
        if: steps.plan.outcome == 'failure'
        run: exit 1

  # ============================================================================
  # Job 3: Terraform Apply (Manual Approval Required)
  # ============================================================================
  terraform-apply:
    name: Terraform Apply
    runs-on: ubuntu-latest
    needs: terraform-plan

    # Only run on manual workflow_dispatch to main branch (no user inputs required)
    if: |
      github.event_name == 'workflow_dispatch' && github.ref == 'refs/heads/main'

    # Require manual approval via GitHub environment
    environment:
      name: production
      url: https://cloud.oracle.com

    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Download Terraform Plan
        if: needs.terraform-plan.outputs.plan-exitcode == '2'
        uses: actions/download-artifact@v4
        with:
          name: terraform-plan
          path: ${{ env.TERRAFORM_DIR }}

      - name: Configure OCI credentials
        run: |
          echo "Configuring OCI credentials for apply..."
          mkdir -p ~/.oci
          echo "OCI credentials configured"

      - name: Terraform Init
        run: terraform init
        working-directory: ${{ env.TERRAFORM_DIR }}

      - name: Terraform Apply
        id: apply
        run: |
          if [ -f "tfplan" ]; then
            echo "Applying existing Terraform plan..."
            terraform apply tfplan
          else
            echo "Creating and applying new Terraform plan..."
            terraform apply \
              -var-file=terraform.tfvars.example \
              -auto-approve
          fi
        working-directory: ${{ env.TERRAFORM_DIR }}
        env:
          TF_VAR_compartment_ocid: ${{ secrets.OCI_COMPARTMENT_OCID }}
          TF_VAR_admin_password: ${{ secrets.DB_ADMIN_PASSWORD }}

      - name: Terraform Output
        id: output
        run: |
          echo "Infrastructure Outputs:"
          terraform output -json > outputs.json

          # Display key outputs (non-sensitive)
          echo "Database ID: $(terraform output -raw database_id || echo 'N/A')"
          echo "Database Name: $(terraform output -raw database_name || echo 'N/A')"
          echo "Service Console: $(terraform output -raw service_console_url || echo 'N/A')"
        working-directory: ${{ env.TERRAFORM_DIR }}
        continue-on-error: true

      - name: Upload Terraform Outputs
        if: steps.apply.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: terraform-outputs
          path: ${{ env.TERRAFORM_DIR }}/outputs.json
          retention-days: 30

      - name: Deployment Summary
        if: steps.apply.outcome == 'success'
        run: |
          echo "## ðŸŽ‰ Infrastructure Provisioning Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** Successfully deployed" >> $GITHUB_STEP_SUMMARY
          echo "**Cost:** \$0.00 (Always Free tier)" >> $GITHUB_STEP_SUMMARY
          echo "**Resources Created:**" >> $GITHUB_STEP_SUMMARY
          echo "- Oracle Autonomous Database (1 OCPU, 20GB)" >> $GITHUB_STEP_SUMMARY
          echo "- Object Storage Bucket (20GB limit)" >> $GITHUB_STEP_SUMMARY
          echo "- VCN and networking resources" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Outputs:** Available in artifacts" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # ============================================================================
  # Job 4: Terraform Destroy - REMOVED FOR SECURITY
  # ============================================================================
  # Destruction moved to separate workflow: destroy-infrastructure.yml
  # This maintains separation of concerns and prevents accidental destruction
