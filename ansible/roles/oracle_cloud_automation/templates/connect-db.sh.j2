#!/bin/bash
# Generated by Ansible - Database Connection Script
# Timestamp: {{ deployment_time }}
# Environment: {{ deployment_environment | default('development') }}

set -euo pipefail

# Configuration
DB_SERVICE="{{ database_name }}_HIGH"
DB_USER="{{ admin_username }}"
DB_PASSWORD="{{ admin_password }}"
WALLET_DIR="{{ wallet_dir }}"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Logging function
log() {
    echo -e "${BLUE}[$(date +'%Y-%m-%d %H:%M:%S')]${NC} $1"
}

error() {
    echo -e "${RED}[ERROR]${NC} $1" >&2
}

success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

# Display connection banner
echo -e "${GREEN}"
cat << 'EOF'
╔══════════════════════════════════════════════════════════════════╗
║              Oracle Database Connection                          ║
║              🚨 ALWAYS FREE TIER PROTECTION 🚨                  ║
╚══════════════════════════════════════════════════════════════════╝
EOF
echo -e "${NC}"

# Validate prerequisites
validate_environment() {
    log "Validating connection environment..."
    
    if [[ ! -d "$WALLET_DIR" ]]; then
        error "Database wallet directory not found: $WALLET_DIR"
        exit 1
    fi
    
    if [[ ! -f "$WALLET_DIR/tnsnames.ora" ]]; then
        error "TNS names file not found: $WALLET_DIR/tnsnames.ora"
        exit 1
    fi
    
    if ! command -v sqlplus &> /dev/null; then
        error "SQL*Plus not found in PATH"
        echo "Please ensure Oracle client tools are installed"
        exit 1
    fi
    
    success "Environment validation completed"
}

# Test connection
test_connection() {
    log "Testing database connection..."
    
    export TNS_ADMIN="$WALLET_DIR"
    
    local test_sql="SELECT 'CONNECTION_SUCCESS' FROM dual;"
    
    if echo "$test_sql" | sqlplus -s "${DB_USER}/${DB_PASSWORD}@${DB_SERVICE}" 2>/dev/null | grep -q "CONNECTION_SUCCESS"; then
        success "Database connection successful"
        return 0
    else
        error "Database connection failed"
        return 1
    fi
}

# Display connection info
display_info() {
    echo ""
    echo "🔗 Connection Information:"
    echo "   Database: ${DB_SERVICE}"
    echo "   User: ${DB_USER}" 
    echo "   Wallet: ${WALLET_DIR}"
    echo "   TNS Admin: ${WALLET_DIR}"
    echo ""
    echo "📋 Available Services:"
    if [[ -f "$WALLET_DIR/tnsnames.ora" ]]; then
        grep -E "^[A-Z_]+.*=" "$WALLET_DIR/tnsnames.ora" | sed 's/=.*//' | sort | sed 's/^/   • /'
    fi
    echo ""
}

# Main connection function
connect_to_database() {
    export TNS_ADMIN="$WALLET_DIR"
    
    echo "🚀 Connecting to Oracle Database..."
    echo "   (Use 'exit' or Ctrl+D to disconnect)"
    echo ""
    
    # Connect to database
    sqlplus "${DB_USER}/${DB_PASSWORD}@${DB_SERVICE}"
}

# Main execution
main() {
    validate_environment
    
    if test_connection; then
        display_info
        
        # Ask user if they want to connect
        echo "Ready to connect to Oracle Database."
        read -p "Press Enter to connect, or Ctrl+C to cancel: "
        
        connect_to_database
    else
        error "Cannot establish database connection"
        echo ""
        echo "Troubleshooting steps:"
        echo "1. Verify wallet files exist in: $WALLET_DIR"
        echo "2. Check network connectivity"
        echo "3. Verify database credentials"
        echo "4. Ensure database is running"
        exit 1
    fi
}

# Execute main function
main "$@"